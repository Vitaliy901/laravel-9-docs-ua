# Скидання пароля

- [Introduction](#introduction)
  - [Підготовлення моделі](#model-preparation)
  - [Підготовлення бази даних](#database-preparation)
  - [Конфігурування довірених хостів](#configuring-trusted-hosts)
- [Маршрутизація](#routing)
  - [Запит на посилання для скидання пароля](#requesting-the-password-reset-link)
  - [Скидання пароля](#resetting-the-password)
- [Видалення прострочених токенів](#deleting-expired-tokens)
- [Налаштування](#password-customization)

<a name="introduction"></a>

## Вступ

Більшість веб-додатків надають користувачам можливість скинути забуті паролі. Замість того, щоб змушувати вас повторно впроваджувати цей функціонал вручну для кожного створеного додатка, Laravel надає зручні послуги для відправлення посилань, з можливістю безпечно скинути пароль.

> **Note**  
> Хочете швидко почати? Встановіть [стартовий набір Laravel](starter-kits.md) у новому додатку Laravel. Стартові набори Laravel подбають про створення всієї вашої системи автентифікації, включаючи скидання забутих паролів.

<a name="model-preparation"></a>

### Підготовлення моделі

Перш ніж використовувати функціонал скидання пароля Laravel, модель `App\Models\User` вашого додатка має використовувати трейт `Illuminate\Notifications\Notifiable`. Як правило, цей трейт вже включено в модель `App\Models\User` за замовчуванням, яка створюється з новим додатком Laravel.

Далі переконайтеся, що ваша модель `App\Models\User` реалізує контракт `Illuminate\Contracts\Auth\CanResetPassword`. Модель `App\Models\User`, яка входить до складу фреймворка, вже реалізує цей інтерфейс і використовує трейт `Illuminate\Auth\Passwords\CanResetPassword`, щоб включити методи, необхідні для реалізації інтерфейса.

<a name="database-preparation"></a>

### Підготовлення бази даних

Необхідно створити таблицю для зберігання токенів скидання пароля вашого додатка. Міграція для цієї таблиці включена в додаток Laravel за замовчуванням, тому вам потрібно лише виконати міграцю, щоб створити цю таблицю:

```shell
php artisan migrate
```

<a name="configuring-trusted-hosts"></a>

### Конфігурування довірених хостів

За замовчуванням Laravel відповідатиме на всі отримані запити незалежно від вмісту заголовка `Host` HTTP-запита. Крім того, значення заголовка `Host` використовуватиметься під час генерації абсолютних URL-адрес вашого додатка, під час веб-запита.

Як правило, вам слід налаштувати веб-сервер, наприклад Nginx або Apache, так, щоб він обслуговував запити, які відповідають лише вказаному імені хоста. Однак якщо у вас немає можливості безпосередньо налаштувати веб-сервер і вам потрібно вказати Laravel відповідати лише на певні імена хостів, ви можете зробити це, задіявши посередник `App\Http\Middleware\TrustHosts` для вашого додатка. Це особливо важливо, якщо ваш додаток пропонує функціонал скидання пароля.

Щоб дізнатися більше про цей посередник, перегляньте [документацію про посередника `TrustHosts`](requests.md#configuring-trusted-hosts).

<a name="routing"></a>

## Маршрутизація

Щоб належним чином реалізувати підтримку можливості користувачам скидати свої паролі, нам потрібно буде визначити декілька маршрутів. По-перше, нам знадобиться пара маршрутів, щоб дозволити користувачеві запросити посилання для скидання пароля через свою електронну адресу. По-друге, нам знадобиться пара маршрутів для фактичного скидання пароля, коли користувач переходить за посиланням для скидання пароля, надісланим йому електронною поштою, і заповнює форму для скидання пароля.

<a name="requesting-the-password-reset-link"></a>

### Запит на посилання для скидання пароля

<a name="the-password-reset-link-request-form"></a>

#### Форма запита посилання для скидання пароля

Спочатку ми визначимо маршрути, необхідні для запита посилання для скидання пароля. Для початку ми визначимо маршрут, який повертає візуалізацію з формою запита на посилання для відновлення пароля:

```php
Route::get('/forgot-password', function () {
    return view('auth.forgot-password');
})->middleware('guest')->name('password.request');
```

Шаблон, який повертається цим маршрутом, повинен мати форму з полем `email`, яке дозволить користувачеві запитувати посилання для скидання пароля для заданої електронної адреси.

<a name="password-reset-link-handling-the-form-submission"></a>

#### Опрацювання форми відправлення

Далі ми визначимо маршрут, який опрацює запит на відправлення форми з шаблона `forgot-password`. Цей маршрут відповідатиме за перевірку електронної адреси та відправлення запита на скидання пароля відповідному користувачеві:

```php
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Password;

Route::post('/forgot-password', function (Request $request) {
    $request->validate(['email' => 'required|email']);

    $status = Password::sendResetLink(
        $request->only('email')
    );

    return $status === Password::RESET_LINK_SENT
                ? back()->with(['status' => __($status)])
                : back()->withErrors(['email' => __($status)]);
})->middleware('guest')->name('password.email');
```

Перш ніж рухатися далі, розглянемо цей маршрут більш детально. Спочатку перевіряється атрибут `email` із запита. Далі ми використаємо вбудований «брокер паролів» Laravel (через фасад `Password`), щоб надіслати користувачеві посилання для скидання пароля. Брокер паролів подбає про отримання користувача за вказаним полем (у цьому випадку це адреса електронної пошти) і відправлення користувачеві посилання для скидання пароля через вбудовану систему повідомлень Laravel.

Метод `sendResetLink` повертає ключ «статус». Цей статус можна перекласти за допомогою помічників [локалізації](localization.md) Laravel, щоб показати користувачеві зручне повідомлення щодо статусу його запита. Переклад статуса скидання пароля визначається мовним файлом `lang/{lang}/passwords.php` вашого додатка. Запис статуса для кожного можливого значення ключа міститься у мовному файлі `passwords`.

Вам може бути цікаво, як Laravel знає, як отримати запис користувача з бази даних вашого доадатка під час виклику метода `sendResetLink` фасада `Password`. Брокер паролів Laravel використовує «user providers» вашої системи автентифікації для отримання записів з бази даних. Провайдер користувача, який використовується брокером паролів, налаштовується в масиві `passwords` вашого конфігураційного файла `config/auth.php`. Щоб дізнатися більше про написання власних «user providers», зверніться до [документації з автентифікації](authentication.md#adding-custom-user-providers).

> **Note**  
> Під час ручного скидання пароля вам потрібно самостійно визначити вміст шаблонів і маршрутів. Якщо вам потрібен готовий каркас, який включає всю необхідну логіку автентифікації та перевірки, ознайомтеся зі [стартовими наборами додатка Laravel](starter-kits.md).

<a name="resetting-the-password"></a>

### Скидання пароля

<a name="the-password-reset-form"></a>

#### Форма скиання пароля

Далі ми визначимо маршрути, необхідні для фактичного скидання пароля, коли користувач натискає посилання для скидання пароля, яке було надіслано йому електронною поштою, та яке містить новий пароль. По-перше, давайте визначимо маршрут, який відображатиме форму скидання пароля, яка відображається, коли користувач натискає посилання скидання пароля. Цей маршрут отримає параметр токена, який ми будемо використовувати пізніше для перевірки запита на скидання пароля:

```php
Route::get('/reset-password/{token}', function ($token) {
    return view('auth.reset-password', ['token' => $token]);
})->middleware('guest')->name('password.reset');
```

Шаблон, який повертає цей маршрут, має відображати форму, яка містить поле `email`, поле `password`, поле `password_confirmation` і поле прихованого `token`, яке має містити значення секретного `$token`, отриманого нашим маршрутом.

<a name="password-reset-handling-the-form-submission"></a>

#### Опрацювання підтвердженої форми

Звичайно, нам потрібно визначити маршрут для фактичного опрацювання підтвердженої форми для скидання пароля. Цей маршрут буде відповідати за перевірку вхідного запита та оновлення пароля користувача в базі даних:

```php
use Illuminate\Auth\Events\PasswordReset;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Password;
use Illuminate\Support\Str;

Route::post('/reset-password', function (Request $request) {
    $request->validate([
        'token' => 'required',
        'email' => 'required|email',
        'password' => 'required|min:8|confirmed',
    ]);

    $status = Password::reset(
        $request->only('email', 'password', 'password_confirmation', 'token'),
        function ($user, $password) {
            $user->forceFill([
                'password' => Hash::make($password)
            ])->setRememberToken(Str::random(60));

            $user->save();

            event(new PasswordReset($user));
        }
    );

    return $status === Password::PASSWORD_RESET
                ? redirect()->route('login')->with('status', __($status))
                : back()->withErrors(['email' => [__($status)]]);
})->middleware('guest')->name('password.update');
```

Перш ніж рухатися далі, розглянемо цей маршрут більш детально. Спочатку перевіряються атрибути`token`, `email` та `password` запита. Далі ми використаємо вбудований «брокер паролів» Laravel (через фасад `Password`), щоб перевірити облікові дані запита на скидання пароля.

Якщо токен, адреса електронної пошти та пароль, надані брокеру паролів, дійсні, буде викликано замикання, передане методу `reset`. У рамках цього замикання, яке отримує екземпляр користувача та простий текстовий пароль, наданий у формі скидання пароля, ми можемо оновити пароль користувача в базі даних.

Метод `reset` повертає ключ "status". Цей статус можна перекласти за допомогою помічників [локалізації](localization.md) Laravel, щоб показати користувачеві зручне повідомлення щодо статусу його запита. Переклад статуса скидання пароля визначається мовним файлом `lang/{lang}/passwords.php` вашого додатка. Запис статуса для кожного можливого значення ключа міститься у мовному файлі `passwords`.

Вам може бути цікаво, як Laravel знає, як отримати запис користувача з бази даних вашого доадатка під час виклику метода `reset` фасада `Password`. Брокер паролів Laravel використовує «user providers» вашої системи автентифікації для отримання записів з бази даних. Провайдер користувача, який використовується брокером паролів, налаштовується в масиві `passwords` вашого конфігураційного файла `config/auth.php`. Щоб дізнатися більше про написання власних «user providers», зверніться до [документації з автентифікації](authentication.md#adding-custom-user-providers).

<a name="deleting-expired-tokens"></a>

## Видалення токенів, термін дії яких мину

Не підтверджені токени скидання пароля, термін дії яких минув, все ще будуть присутні у вашій базі даних. Однак ви можете легко видалити ці записи за допомогою команди `auth:clear-resets` Artisan:

```shell
php artisan auth:clear-resets
```

Якщо ви хочете автоматизувати цей процес, розгляньте можливість додавання команди до [планувальника](scheduling.md) додатка:

```php
$schedule->command('auth:clear-resets')->everyFifteenMinutes();
```

<a name="password-customization"></a>

## Налаштування

<a name="reset-link-customization"></a>

#### Налаштування посилання для скидання пароля

Ви можете налаштувати URL-адресу посилання для скидання пароля за допомогою метода `createUrlUsing`, наданого класом повідомлення `ResetPassword`. Цей метод приймає замикання, яке отримає екземпляр користувача, якому надсилається повідомлення, а також токен посилання для скидання пароля. Як правило, цей метод слід викликати з метода `boot` постачальника послуг `App\Providers\AuthServiceProvider`:

```php
use Illuminate\Auth\Notifications\ResetPassword;

/**
 * Реєстрація будь-яких служб автентифікації/авторизації.
 *
 * @return void
 */
public function boot()
{
    $this->registerPolicies();

    ResetPassword::createUrlUsing(function ($user, string $token) {
        return 'https://example.com/reset-password?token=' . $token;
    });
}
```

<a name="reset-email-customization"></a>

#### Налаштування повідомлень про скидання пароля

Ви можете легко змінити клас повідомлення, який використовується для відправлення користувачеві посилання для скидання пароля. Щоб почати, перевизначте метод `sendPasswordResetNotification` в своїй моделі `App\Models\User`. У цьому методі ви можете надіслати повідомлення, використовуючи будь-який створений вами [клас повідомлення](notifications.md). `$token` для скидання пароля є першим аргументом, який отримає метод. Ви можете використовувати цей `$token`, щоб створити URL-адресу для скидання пароля за вашим вибором і надіслати повідомлення користувачеві:

```php
use App\Notifications\ResetPasswordNotification;

/**
 * Надіслати користувачеві повідомлення про скидання пароля.
 *
 * @param  string  $token
 * @return void
 */
public function sendPasswordResetNotification($token)
{
    $url = 'https://example.com/reset-password?token=' . $token;

    $this->notify(new ResetPasswordNotification($url));
}
```
